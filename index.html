<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ezlive - P2P 화상 강의</title>
    <link rel="stylesheet" href="css/style.css">
    
    <!-- 카카오톡/인앱 브라우저 감지 및 외부 브라우저 열기 -->
    <script>
        (function() {
            const userAgent = navigator.userAgent.toLowerCase();
            const currentUrl = window.location.href;
            
            // 카카오톡 인앱 브라우저 감지
            const isKakaoTalk = userAgent.indexOf('kakaotalk') > -1;
            
            // 네이버 인앱 브라우저 감지
            const isNaver = userAgent.indexOf('naver') > -1;
            
            // 페이스북 인앱 브라우저 감지
            const isFacebook = userAgent.indexOf('fban') > -1 || userAgent.indexOf('fbav') > -1;
            
            // 인스타그램 인앱 브라우저 감지
            const isInstagram = userAgent.indexOf('instagram') > -1;
            
            // 라인 인앱 브라우저 감지
            const isLine = userAgent.indexOf('line') > -1;
            
            // 기타 인앱 브라우저
            const isInAppBrowser = isKakaoTalk || isNaver || isFacebook || isInstagram || isLine;
            
            if (isInAppBrowser) {
                // 모바일 환경인지 확인
                const isMobile = /android|iphone|ipad|ipod/i.test(userAgent);
                
                if (isMobile) {
                    // iOS인 경우
                    if (/iphone|ipad|ipod/i.test(userAgent)) {
                        // iOS는 intent 스킴이 없으므로 안내 페이지 표시
                        showOpenInBrowserGuide('iOS');
                    } 
                    // Android인 경우
                    else if (/android/i.test(userAgent)) {
                        // Android Chrome으로 열기 시도
                        const intentUrl = 'intent://' + currentUrl.replace(/https?:\/\//, '') + '#Intent;scheme=https;package=com.android.chrome;end';
                        window.location.href = intentUrl;
                        
                        // 1초 후에도 페이지가 그대로면 안내 표시
                        setTimeout(function() {
                            showOpenInBrowserGuide('Android');
                        }, 1000);
                    }
                } else {
                    // 데스크톱 환경
                    showOpenInBrowserGuide('Desktop');
                }
            }
            
            function showOpenInBrowserGuide(platform) {
                // 기존 컨텐츠 숨기기
                document.addEventListener('DOMContentLoaded', function() {
                    const container = document.querySelector('.container');
                    if (container) {
                        container.style.display = 'none';
                    }
                    
                    // 안내 페이지 생성
                    const guideDiv = document.createElement('div');
                    guideDiv.id = 'inAppBrowserGuide';
                    guideDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 999999;';
                    
                    let guideContent = '';
                    
                    if (platform === 'iOS') {
                        guideContent = `
                            <div style="background: white; padding: 40px; border-radius: 20px; max-width: 90%; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                                <h2 style="color: #667eea; margin-bottom: 20px; font-size: 1.8rem;">🔗 외부 브라우저에서 열기</h2>
                                <p style="color: #666; margin-bottom: 30px; line-height: 1.6;">
                                    카메라와 마이크를 사용하려면<br>
                                    Safari 브라우저에서 열어주세요!
                                </p>
                                <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: left;">
                                    <p style="font-weight: 600; margin-bottom: 10px; color: #333;">📱 iOS 사용 방법:</p>
                                    <ol style="padding-left: 20px; color: #666; line-height: 2;">
                                        <li>우측 하단 <strong>공유</strong> 버튼 (↗️) 클릭</li>
                                        <li><strong>Safari에서 열기</strong> 선택</li>
                                    </ol>
                                </div>
                                <p style="font-size: 0.9rem; color: #999;">또는 주소를 복사하여 Safari에 직접 붙여넣으세요</p>
                            </div>
                        `;
                    } else if (platform === 'Android') {
                        guideContent = `
                            <div style="background: white; padding: 40px; border-radius: 20px; max-width: 90%; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                                <h2 style="color: #667eea; margin-bottom: 20px; font-size: 1.8rem;">🔗 외부 브라우저에서 열기</h2>
                                <p style="color: #666; margin-bottom: 30px; line-height: 1.6;">
                                    카메라와 마이크를 사용하려면<br>
                                    Chrome 브라우저에서 열어주세요!
                                </p>
                                <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: left;">
                                    <p style="font-weight: 600; margin-bottom: 10px; color: #333;">📱 Android 사용 방법:</p>
                                    <ol style="padding-left: 20px; color: #666; line-height: 2;">
                                        <li>우측 상단 <strong>⋮</strong> (더보기) 클릭</li>
                                        <li><strong>다른 브라우저에서 열기</strong> 선택</li>
                                        <li><strong>Chrome</strong> 선택</li>
                                    </ol>
                                </div>
                                <button onclick="navigator.clipboard.writeText('${currentUrl}').then(() => alert('링크가 복사되었습니다! Chrome에 붙여넣으세요.'))" 
                                        style="background: #667eea; color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 1rem; cursor: pointer; margin-top: 10px;">
                                    📋 링크 복사하기
                                </button>
                            </div>
                        `;
                    } else {
                        guideContent = `
                            <div style="background: white; padding: 40px; border-radius: 20px; max-width: 90%; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                                <h2 style="color: #667eea; margin-bottom: 20px; font-size: 1.8rem;">🔗 외부 브라우저에서 열기</h2>
                                <p style="color: #666; margin-bottom: 30px; line-height: 1.6;">
                                    원활한 사용을 위해<br>
                                    기본 브라우저에서 열어주세요!
                                </p>
                                <p style="font-size: 0.9rem; color: #999;">더보기 메뉴에서 "외부 브라우저에서 열기"를 선택하세요</p>
                            </div>
                        `;
                    }
                    
                    guideDiv.innerHTML = guideContent;
                    document.body.appendChild(guideDiv);
                });
            }
        })();
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>🎥 ezlive</h1>
            <p class="copyright">Copyright (주)이지올댓, 연세대학교 인지공학 연구실</p>
            <p class="subtitle">화상 솔루션</p>
        </header>

        <!-- 컨트롤 바 (헤더 아래 배치, step3에서만 표시) -->
        <div id="controlsBar" class="controls-bar" style="display: none;">
            <button id="toggleVideoBtn" class="btn-control-bar" title="비디오 끄기/켜기">
                <span class="icon">📹</span>
                <span class="label">비디오</span>
            </button>
            <button id="toggleAudioBtn" class="btn-control-bar" title="마이크 끄기/켜기">
                <span class="icon">🎤</span>
                <span class="label">마이크</span>
            </button>
            <button id="shareScreenBtn" class="btn-control-bar" title="화면 공유">
                <span class="icon">🖥️</span>
                <span class="label">화면공유</span>
            </button>
            <button id="whiteboardBtn" class="btn-control-bar btn-whiteboard" title="판서도구 (화이트보드)">
                <span class="icon">✏️</span>
                <span class="label">판서도구</span>
            </button>
            <button id="toggleChatViewBtn" class="btn-control-bar" title="채팅창 열기/닫기">
                <span class="icon">💬</span>
                <span class="label">채팅창</span>
            </button>
            <button id="downloadChatBtn" class="btn-control-bar" title="채팅 기록 다운로드">
                <span class="icon">💾</span>
                <span class="label">채팅저장</span>
            </button>
            <button id="lmsBtn" class="btn-control-bar btn-lms" title="LMS 바로가기">
                <span class="icon">🎓</span>
                <span class="label">LMS</span>
            </button>
            <button id="bookBtn" class="btn-control-bar btn-book" title="교재자료실">
                <span class="icon">📚</span>
                <span class="label">교재자료실</span>
            </button>
            <button id="replayBtn" class="btn-control-bar btn-replay" title="다시보기">
                <span class="icon">🔄</span>
                <span class="label">다시보기</span>
            </button>
            <button id="recordBtn" class="btn-control-bar btn-record" title="녹화 시작/중지">
                <span class="icon">⏺️</span>
                <span class="label">녹화</span>
            </button>
            <button id="recordFolderBtn" class="btn-control-bar btn-folder" title="녹화 폴더 열기">
                <span class="icon">📁</span>
                <span class="label">녹화폴더</span>
            </button>
            <button id="endCallBtn" class="btn-control-bar btn-danger" title="통화 종료">
                <span class="icon">❌</span>
                <span class="label">종료</span>
            </button>
        </div>

        <!-- Step 0: 교사/학생 선택 -->
        <div id="step0" class="step active">
            <div class="card">
                <h2>👥 사용자 선택</h2>
                <p>교사 또는 학생을 선택하세요</p>
                <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 30px;">
                    <button id="selectTeacherBtn" class="btn btn-primary" style="padding: 20px; font-size: 1.2rem;">
                        🏫 교사 시작
                    </button>
                    <button id="selectStudentBtn" class="btn btn-secondary" style="padding: 20px; font-size: 1.2rem;">
                        🎓 학생 시작
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 0.5: 교사 비밀번호 인증 -->
        <div id="stepTeacherAuth" class="step">
            <div class="card">
                <h2>🔐 교사 인증</h2>
                <p>교사 전용 비밀번호를 입력하세요</p>
                <input type="password" id="teacherAuthPassword" placeholder="교사 비밀번호 입력" class="input" style="margin-top: 20px;">
                <button id="teacherAuthBtn" class="btn btn-primary">인증하기</button>
                <button id="backToSelectBtn" class="btn btn-secondary" style="margin-top: 10px;">뒤로 가기</button>
            </div>
        </div>

        <!-- Step 1: 서버 생성 -->
        <div id="step1" class="step">
            <div class="card" id="teacherCard">
                <h2>🏫 교사용 화상강의 생성</h2>
                <p>강의를 생성하고 학생들을 초대하세요.</p>
                <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                    <button id="saveTeacherInfoBtn" class="btn btn-success btn-small">💾 입력저장</button>
                    <button id="loadTeacherInfoBtn" class="btn btn-secondary btn-small">📂 정보불러오기</button>
                </div>
                <input type="text" id="teacherName" placeholder="교사 이름 입력" class="input">
                <input type="text" id="teacherClassCode" placeholder="회의실 이름 입력 (예: math2024, class01)" class="input">
                <input type="password" id="teacherPassword" placeholder="회의실 비밀번호 입력" class="input">
                <p class="hint">💡 입력 순서: 이름 → 회의실 이름 → 비밀번호</p>
                <button id="createHostBtn" class="btn btn-primary">회의실 생성</button>
                
                <!-- 숨겨진 파일 업로드 input -->
                <input type="file" id="teacherInfoFileInput" accept=".txt" style="display: none;">
            </div>

            <div class="card" id="studentCard" style="display: none;">
                <h2>🎓 학생용 회의실 참여</h2>
                <p>교사가 공유한 회의실 코드와 비밀번호를 입력하세요.</p>
                <input type="text" id="studentName" placeholder="학생 이름 입력" class="input">
                <input type="text" id="joinPeerId" placeholder="회의실 코드 입력" class="input">
                <input type="password" id="studentPassword" placeholder="회의실 비밀번호 입력" class="input">
                <button id="joinBtn" class="btn btn-secondary">회의실 참여</button>
                <button id="backToSelectFromStudentBtn" class="btn btn-secondary" style="margin-top: 10px;">뒤로 가기</button>
            </div>
        </div>

        <!-- Step 2: 서버 주소 공유 -->
        <div id="step2" class="step">
            <div class="card">
                <h2>2️⃣ 회의실 코드 공유하기</h2>
                <p>아래 코드를 학생들에게 공유하세요.</p>
                
                <div class="share-box">
                    <div class="peer-id-display">
                        <strong>회의실 코드:</strong>
                        <div id="myPeerId" class="peer-id"></div>
                    </div>
                    <button id="copyBtn" class="btn btn-copy">📋 코드 복사</button>
                </div>

                <div class="divider">또는</div>

                <div class="share-box invitation-box">
                    <div class="peer-id-display">
                        <strong>🔗 초대 링크:</strong>
                        <div id="invitationLink" class="invitation-link"></div>
                    </div>
                    <button id="copyInvitationBtn" class="btn btn-copy">🔗 링크 복사</button>
                </div>
                <p class="invitation-note">💡 초대 링크를 사용하면 학생이 이름만 입력하고 바로 참여할 수 있습니다!</p>

                <div class="status-box">
                    <div id="connectionStatus">학생의 접속을 기다리는 중...</div>
                </div>
            </div>
        </div>

        <!-- Step 3: 화상 채팅 -->
        <div id="step3" class="step">
            <div class="main-layout" id="mainLayout">
                <div class="video-container" id="videoContainer">
                    <div class="video-wrapper" id="remoteVideoWrapper">
                        <video id="remoteVideo" autoplay playsinline></video>
                        <div class="video-label">상대방</div>
                        <div class="video-controls">
                            <button id="remoteCaptureBtn" class="btn-video-control" title="화면 캡쳐">
                                <span class="icon">📸</span>
                            </button>
                            <button id="remotePipBtn" class="btn-video-control" title="PIP 모드">
                                <span class="icon">🖼️</span>
                            </button>
                            <button id="remoteMaximizeBtn" class="btn-video-control" title="최대화/최소화">
                                <span class="icon">⤢</span>
                            </button>
                            <button id="fullscreenBtn" class="btn-video-control" title="전체화면">
                                <span class="icon">⛶️</span>
                            </button>
                        </div>
                    </div>
                    <div class="video-wrapper local" id="localVideoWrapper">
                        <video id="localVideo" autoplay playsinline muted></video>
                        <div class="video-label">나</div>
                        <div class="video-controls">
                            <button id="switchCameraBtn" class="btn-video-control" title="카메라 전환" style="display: none;">
                                <span class="icon">🔄</span>
                            </button>
                            <button id="localCaptureBtn" class="btn-video-control" title="화면 캡쳐">
                                <span class="icon">📸</span>
                            </button>
                            <button id="localPipBtn" class="btn-video-control" title="내 화면 PIP">
                                <span class="icon">🖼️</span>
                            </button>
                            <button id="localMaximizeBtn" class="btn-video-control" title="최대화/최소화">
                                <span class="icon">⤢</span>
                            </button>
                            <button id="localFullscreenBtn" class="btn-video-control" title="전체화면">
                                <span class="icon">⛶️</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="chat-container" id="chatContainer">
                    <div class="chat-header">
                        <h3>💬 채팅</h3>
                        <div class="chat-header-actions">
                            <button id="screenShareDrawingBtn" class="btn-icon" title="판서도구 (화면공유 중)" style="display: none;">✏️</button>
                            <button id="closeDrawingBtn" class="btn-icon" title="판서도구 종료" style="display: none; background: #f44336; color: white;">✕</button>
                            <button id="fullscreenChatBtn" class="btn-icon" title="채팅 전체화면">⛶️</button>
                            <button id="popoutChatBtn" class="btn-icon" title="새창으로 열기">🗗️</button>
                            <button id="closeChatBtn" class="btn-close mobile-only">✕</button>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="file" id="fileInput" style="display: none;">
                        <button id="fileBtn" class="btn btn-file" title="파일 전송">파일전송</button>
                        <input type="text" id="chatInput" placeholder="메시지를 입력하세요..." class="chat-input">
                        <button id="sendBtn" class="btn btn-send">전송</button>
                    </div>
                    <div id="chatMessages" class="chat-messages"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 화면공유 승인 요청 모달 -->
    <div id="screenShareRequestModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>📢 화면공유 요청</h3>
            <p id="requestMessage">학생이 화면공유를 요청했습니다.</p>
            <div class="modal-buttons">
                <button id="approveScreenShareBtn" class="btn btn-approve">✅ 승인</button>
                <button id="rejectScreenShareBtn" class="btn btn-reject">❌ 거부</button>
            </div>
        </div>
    </div>

    <!-- 종료 시 채팅 저장 확인 모달 -->
    <div id="endCallModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>📞 통화 종료</h3>
            <p>채팅 기록을 저장하시겠습니까?</p>
            <div class="modal-buttons">
                <button id="saveChatAndEndBtn" class="btn btn-approve">💾 저장하고 종료</button>
                <button id="endWithoutSaveBtn" class="btn btn-secondary">종료만</button>
                <button id="cancelEndBtn" class="btn btn-reject">취소</button>
            </div>
        </div>
    </div>

    <!-- 판서 도구 (화면공유 중에만 표시) -->
    <div id="drawingTools" class="drawing-tools" style="display: none;">
        <div class="drawing-tools-header">
            <span>🖊️ 판서 도구</span>
            <button id="closeDrawingBtn" class="btn-close-drawing">✕</button>
        </div>
        <div class="drawing-tools-body">
            <label>색상:</label>
            <input type="color" id="drawColor" value="#ff0000">
            
            <label>굵기:</label>
            <input type="range" id="drawWidth" min="1" max="20" value="3">
            <span id="widthValue">3</span>
            
            <button id="penBtn" class="btn-tool active">🖊️ 펜</button>
            <button id="eraserBtn" class="btn-tool">🧹 지우개</button>
            <button id="pointerBtn" class="btn-tool">🔴 포인터</button>
            <button id="clearDrawingBtn" class="btn-tool">🗑️ 전체삭제</button>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
